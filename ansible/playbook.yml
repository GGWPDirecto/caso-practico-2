---
- name: Configuración y Despliegue General
  hosts: localhost
  gather_facts: false
  vars:
    key_vault_name: "kve3uprdfi" # Reemplaza con el nombre de tu Key Vault si es diferente
    acr_password_secret_name: "acr-password"

  pre_tasks:
    - name: Obtener contraseña de ACR desde Azure Key Vault
      ansible.builtin.set_fact:
        acr_password: "{{ lookup('community.general.azure.key_vault_secret', secret=acr_password_secret_name, vault_url='https://' + key_vault_name + '.vault.azure.net/') }}"
      delegate_to: localhost

    - name: Descargar kubeconfig con az cli
      ansible.builtin.shell: |
        az aks get-credentials --resource-group rg-casopractico2 --name aks-casopractico2 --overwrite-existing
      environment:
        AZURE_CONFIG_DIR: ~/.azure
      register: kubeconfig_result
      changed_when: false
      delegate_to: localhost

- name: Subida de imágenes a ACR
  hosts: localhost
  vars_files:
    - vault.yml
  roles:
    - acr

- name: Despliegue en VM con Podman
  hosts: vm
  become: true
  vars_files:
    - vault.yml
  roles:
    - vm

- name: Despliegue en AKS
  hosts: localhost
  vars_files:
    - vault.yml
  roles:
    - aks


