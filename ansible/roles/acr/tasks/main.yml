---
# Tareas para el rol de ACR
- name: Login en ACR
  community.docker.docker_login:
    registry_url: "{{ acr_login_server }}"
    username: "{{ acr_username }}"
    password: "{{ acr_password }}"
  delegate_to: localhost

- name: Gestionar imÃ¡genes (pull, tag, push) en bucle
  block:
    - name: Descargar imagen desde DockerHub
      community.docker.docker_image:
        name: "{{ item.source_image }}"
        source: pull
        force_source: true
      delegate_to: localhost

    - name: Etiquetar imagen para ACR
      ansible.builtin.command: >
        docker tag {{ item.source_image }} {{ acr_login_server }}/{{ item.name }}:{{ acr_image_tag }}
      delegate_to: localhost
      ignore_errors: true

    - name: Subir imagen a ACR
      community.docker.docker_image:
        name: "{{ acr_login_server }}/{{ item.name }}"
        tag: "{{ acr_image_tag }}"
        source: local
        push: true
      delegate_to: localhost
  loop: "{{ acr_images }}"
