---
# Tareas para el rol de ACR
- name: Login en ACR
  community.docker.docker_login:
    registry_url: "{{ acr_login_server }}"
    username: "{{ acr_username }}"
    password: "{{ acr_password }}"
  delegate_to: localhost



- name: Descargar imagen desde DockerHub (solo imágenes públicas)
  community.docker.docker_image:
    name: "{{ item.source_image }}"
    source: pull
    force_source: true
  delegate_to: localhost
  loop: "{{ acr_images }}"
  when: item.source_image is search('nginx:latest')

- name: Etiquetar imagen para ACR
  ansible.builtin.command: >
    docker tag {{ item.source_image }} {{ acr_login_server }}/{{ item.name }}:{{ acr_image_tag }}
  delegate_to: localhost
  ignore_errors: true
  loop: "{{ acr_images }}"

- name: Subir imagen a ACR
  community.docker.docker_image:
    name: "{{ acr_login_server }}/{{ item.name }}"
    tag: "{{ acr_image_tag }}"
    source: local
    push: true
  delegate_to: localhost
  loop: "{{ acr_images }}"
